name: Lets-Go-WorkSpace CI/CD

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18.x]
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
    
    - name: Install backend dependencies
      run: |
        cd backend
        npm ci
      if: hashFiles('backend/package-lock.json') != ''
    
    - name: Install frontend dependencies
      run: |
        cd frontend
        npm ci
      if: hashFiles('frontend/package-lock.json') != ''
    
    - name: Lint backend
      run: |
        cd backend
        npm run lint --if-present
      continue-on-error: true
    
    - name: Lint frontend
      run: |
        cd frontend
        npm run lint --if-present
      continue-on-error: true
    
    - name: Run backend tests
      run: |
        cd backend
        npm run test --if-present
      continue-on-error: true
    
    - name: Run frontend tests
      run: |
        cd frontend
        npm run test --if-present
      continue-on-error: true
    
    - name: Build backend
      run: |
        cd backend
        npm run build --if-present
      continue-on-error: true
    
    - name: Build frontend
      run: |
        cd frontend
        npm run build --if-present
      continue-on-error: true
    
    - name: Upload build artifacts
      if: success()
      uses: actions/upload-artifact@v3
      with:
        name: build-artifacts
        path: |
          backend/dist
          frontend/build
        retention-days: 5
    
    - name: Create deployment summary
      if: always()
      run: |
        echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "- Repository: Lets-Go-WorkSpace" >> $GITHUB_STEP_SUMMARY
        echo "- Commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- Branch: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- Status: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY

  code-quality:
    runs-on: ubuntu-latest
    needs: build
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: 18.x
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run SonarQube Analysis
      run: echo "SonarQube analysis would run here"
      continue-on-error: true

  security-scan:
    runs-on: ubuntu-latest
    needs: build
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Run security scan
      run: |
        echo "Security scanning would run here"
        echo "- OWASP Dependency Check"
        echo "- NPM audit"
        echo "- SAST scanning"
      continue-on-error: true

  deploy:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    needs: [build, code-quality, security-scan]
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Deploy notification
      run: |
        echo "Deployment would happen here"
        echo "Steps:"
        echo "1. Build Docker images"
        echo "2. Push to container registry"
        echo "3. Deploy to production"
        echo "4. Run smoke tests"
        echo "5. Update monitoring dashboards"
    
    - name: Create GitHub Release
      if: success()
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ github.run_number }}
        release_name: Release ${{ github.run_number }}
        body: |
          Automated release for commit ${{ github.sha }}
          Branch: main
        draft: false
        prerelease: false
      continue-on-error: true
